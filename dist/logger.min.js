var RiseVision=RiseVision||{};RiseVision.Common=RiseVision.Common||{},RiseVision.Common.LoggerUtils=function(){"use strict";function e(e){return t(e,window.location.href)}function t(e,t){e=e.replace(/[[]]/g,"\\$&");var n=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)"),o=n.exec(t);return o?o[2]?decodeURIComponent(o[2].replace(/\+/g," ")):"":null}function n(){var e=new Date,t=e.getUTCFullYear(),n=e.getUTCMonth()+1,o=e.getUTCDate();return 10>n&&(n="0"+n),10>o&&(o="0"+o),""+t+n+o}function o(e){var t,n=/[?#&]/;return e&&"string"==typeof e?(t=e.substr(e.lastIndexOf(".")+1),n.test(t)&&(t=t.substr(0,-1!==t.indexOf("?")?t.indexOf("?"):t.length),t=t.substr(0,-1!==t.indexOf("#")?t.indexOf("#"):t.length),t=t.substr(0,-1!==t.indexOf("&")?t.indexOf("&"):t.length)),t.toLowerCase()):null}function i(e){var t={kind:"bigquery#tableDataInsertAllRequest",skipInvalidRows:!1,ignoreUnknownValues:!1,templateSuffix:n(),rows:[{insertId:""}]},o=JSON.parse(JSON.stringify(t));return o.rows[0].insertId=Math.random().toString(36).substr(2).toUpperCase(),o.rows[0].json=JSON.parse(JSON.stringify(e)),o.rows[0].json.ts=(new Date).toISOString(),o}function r(e,t,n){a(t,n)}function s(e){if(u()){var t=window.top.RiseVision.Viewer.Logger.heartbeatInterval(),n=window.top.RiseVision.Viewer.Logger.recordUptimeHeartbeat,o=n.bind(null,{eventApp:e,eventAppVersion:f});o(),setInterval(o,t)}}function a(e,t){return t&&p()?e.event_details&&t.severity&&t.eventApp?(window.top.RiseVision.Viewer.Logger.logTemplateEvent({severity:t.severity,eventApp:t.eventApp,eventAppVersion:f,eventDetails:e.event_details||null,eventErrorCode:t.errorCode||null,debugInfo:e.error_details||t.debugInfo||null}),void 0):console.error("invalid endpoint logging attempt"):void 0}function l(e,t){try{top.postToPlayer({message:"widget-log",table:e,params:JSON.stringify(t),suffix:n()})}catch(o){console.log("widget-common.logEventToPlayer",o)}}function g(e,t){w=e,c=t}function d(e){f=e}function p(){var e=!1;try{e=window.top&&window.top.RiseVision&&window.top.RiseVision.Viewer&&window.top.RiseVision.Viewer.Logger&&window.top.RiseVision.Viewer.Logger.logTemplateEvent}catch(t){e=!1,console.debug&&console.debug(t)}return e}function u(){var e=!1;try{e=window.top&&window.top.RiseVision&&window.top.RiseVision.Viewer&&window.top.RiseVision.Viewer.Logger&&window.top.RiseVision.Viewer.Logger.recordUptimeHeartbeat}catch(t){e=!1,console.debug&&console.debug(t)}return e}var c="",w="",f=null;return{getInsertData:i,getFileFormat:o,getQueryParameter:e,getQueryStringParameter:t,logEvent:r,logEventToPlayer:l,startEndpointHeartbeats:s,logEndpointEvent:a,setIds:g,setVersion:d}}(),RiseVision.Common.Logger=function(e){"use strict";function t(e){var t=new XMLHttpRequest;return new Date-g<358e4?e({}):(t.open("POST",i,!0),t.onloadend=function(){var n={};try{n=JSON.parse(t.response)}catch(o){console.warn("Can't refresh logger token - ",o.message)}e({token:n.access_token,refreshedAt:new Date})},t.send(),void 0)}function n(e){return s&&l===e}function o(o,i){function p(t){var n,s,a=new XMLHttpRequest;s=r.replace("TABLE_ID",o),g=t.refreshedAt||g,d=t.token||d,n=e.getInsertData(i),a.open("POST",s,!0),a.setRequestHeader("Content-Type","application/json"),a.setRequestHeader("Authorization","Bearer "+d),i.cb&&"function"==typeof i.cb&&(a.onloadend=function(){i.cb(a.response)}),a.send(JSON.stringify(n))}if(!(!o||!i||i.hasOwnProperty("event")&&!i.event||i.hasOwnProperty("event")&&n(i.event))&&(i.presentation_type&&"sharedschedule"===i.presentation_type||i.display_id&&"preview"!==i.display_id&&"display_id"!==i.display_id&&"displayId"!==i.display_id)){try{if(top.postToPlayer&&top.enableWidgetLogging)return e.logEventToPlayer(o,i)}catch(u){console.log("widget-common: logger",u)}return s=!0,l=i.event,setTimeout(function(){s=!1},a),t(p)}}var i="https://www.googleapis.com/oauth2/v3/token?client_id="+WIDGET_COMMON_CONFIG.LOGGER_CLIENT_ID+"&client_secret="+WIDGET_COMMON_CONFIG.LOGGER_CLIENT_SECRET+"&refresh_token="+WIDGET_COMMON_CONFIG.LOGGER_REFRESH_TOKEN+"&grant_type=refresh_token",r="https://www.googleapis.com/bigquery/v2/projects/client-side-events/datasets/Widget_Events/tables/TABLE_ID/insertAll",s=!1,a=1e3,l="",g=0,d="";return{log:o}}(RiseVision.Common.LoggerUtils);
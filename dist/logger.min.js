var RiseVision=RiseVision||{};RiseVision.Common=RiseVision.Common||{},RiseVision.Common.LoggerUtils=function(){"use strict";function e(e,o){var i=null;if(e.event){i=e,i.file_url&&(i.file_format=e.file_format||r(i.file_url)),i.company_id=d,i.display_id=g;var s=t("parent"),a=t("type"),l=t("env"),u=t("viewerId"),p=a?a:s?n("type",s):"",f=l?l:s?n("env",s):"",_=u?u:s?n("viewerId",s):"",v=s?n("id",s):"";i.viewer_id=_,"sharedschedule"===p&&(i.presentation_type=p,i.schedule_id=v,i.env=f),c&&(i.version=c),o(i)}else o(i)}function t(e){return n(e,window.location.href)}function n(e,t){e=e.replace(/[[]]/g,"\\$&");var n=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)"),o=n.exec(t);return o?o[2]?decodeURIComponent(o[2].replace(/\+/g," ")):"":null}function o(){var e=new Date,t=e.getUTCFullYear(),n=e.getUTCMonth()+1,o=e.getUTCDate();return 10>n&&(n="0"+n),10>o&&(o="0"+o),""+t+n+o}function r(e){var t,n=/[?#&]/;return e&&"string"==typeof e?(t=e.substr(e.lastIndexOf(".")+1),n.test(t)&&(t=t.substr(0,-1!==t.indexOf("?")?t.indexOf("?"):t.length),t=t.substr(0,-1!==t.indexOf("#")?t.indexOf("#"):t.length),t=t.substr(0,-1!==t.indexOf("&")?t.indexOf("&"):t.length)),t.toLowerCase()):null}function i(e){var t={kind:"bigquery#tableDataInsertAllRequest",skipInvalidRows:!1,ignoreUnknownValues:!1,templateSuffix:o(),rows:[{insertId:""}]},n=JSON.parse(JSON.stringify(t));return n.rows[0].insertId=Math.random().toString(36).substr(2).toUpperCase(),n.rows[0].json=JSON.parse(JSON.stringify(e)),n.rows[0].json.ts=(new Date).toISOString(),n}function s(t,n){e(n,function(e){null!==e&&RiseVision.Common.Logger.log(t,e)})}function a(e,t){try{top.postToPlayer({message:"widget-log",table:e,params:JSON.stringify(t),suffix:o()})}catch(n){console.log("widget-common.logEventToPlayer",n)}}function l(e,t){d=e,g=t}function u(e){c=e}var g="",d="",c=null;return{getInsertData:i,getFileFormat:r,getQueryParameter:t,getQueryStringParameter:n,logEvent:s,logEventToPlayer:a,setIds:l,setVersion:u}}(),RiseVision.Common.Logger=function(e){"use strict";function t(e){var t=new XMLHttpRequest;return new Date-u<358e4?e({}):(t.open("POST",r,!0),t.onloadend=function(){var n={};try{n=JSON.parse(t.response)}catch(o){console.warn("Can't refresh logger token - ",o.message)}e({token:n.access_token,refreshedAt:new Date})},t.send(),void 0)}function n(e){return s&&l===e}function o(o,r){function d(t){var n,s,a=new XMLHttpRequest;s=i.replace("TABLE_ID",o),u=t.refreshedAt||u,g=t.token||g,n=e.getInsertData(r),a.open("POST",s,!0),a.setRequestHeader("Content-Type","application/json"),a.setRequestHeader("Authorization","Bearer "+g),r.cb&&"function"==typeof r.cb&&(a.onloadend=function(){r.cb(a.response)}),a.send(JSON.stringify(n))}if(!(!o||!r||r.hasOwnProperty("event")&&!r.event||r.hasOwnProperty("event")&&n(r.event))&&(r.presentation_type&&"sharedschedule"===r.presentation_type||r.display_id&&"preview"!==r.display_id&&"display_id"!==r.display_id&&"displayId"!==r.display_id)){try{if(top.postToPlayer&&top.enableWidgetLogging)return e.logEventToPlayer(o,r)}catch(c){console.log("widget-common: logger",c)}return s=!0,l=r.event,setTimeout(function(){s=!1},a),t(d)}}var r="https://www.googleapis.com/oauth2/v3/token?client_id="+WIDGET_COMMON_CONFIG.LOGGER_CLIENT_ID+"&client_secret="+WIDGET_COMMON_CONFIG.LOGGER_CLIENT_SECRET+"&refresh_token="+WIDGET_COMMON_CONFIG.LOGGER_REFRESH_TOKEN+"&grant_type=refresh_token",i="https://www.googleapis.com/bigquery/v2/projects/client-side-events/datasets/Widget_Events/tables/TABLE_ID/insertAll",s=!1,a=1e3,l="",u=0,g="";return{log:o}}(RiseVision.Common.LoggerUtils);